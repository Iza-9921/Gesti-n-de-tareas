<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sistema de GestiÃ³n de Tareas â€” Moderno</title>
    <link rel="stylesheet" th:href="@{/css/estilos.css}" href="/css/estilos.css" />
</head>
<body>
<div class="wrap">
    <header>
        <div class="brand">
            <div class="logo" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M4 12c0-4.418 3.582-8 8-8s8 3.582 8 8" stroke="#fff" stroke-opacity="0.95" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div>
                <h1>Sistema de GestiÃ³n de Tareas</h1>
                <p class="lead">Organiza, prioriza y completa tus tareas â€” interfaz moderna y dinÃ¡mica</p>
            </div>
        </div>

        <div class="center">
            <div style="text-align:right">
                <div class="muted">Siguiente en cola</div>
                <div id="colaFrontSmall" class="muted" th:text="${siguienteEnCola != null ? siguienteEnCola : 'â€”'}">â€”</div>
            </div>
            <div class="queue-indicator" id="queueCount" th:text="${totalEnCola != null ? totalEnCola : 0}">0</div>
        </div>
    </header>

    <!-- ðŸ”µ BOTÃ“N NUEVO PARA VER ÃRBOL -->
    <div style="max-width: 1000px; margin: 0 auto 25px auto; text-align: right;">
        <a href="/ordenadas"
           style="
               background: linear-gradient(135deg, #3AA0FF, #6F5BFF);
               padding: 10px 20px;
               border-radius: 12px;
               color: #fff;
               font-weight: 600;
               text-decoration: none;
               box-shadow: 0 4px 12px rgba(0,0,0,0.25);
               display: inline-block;
               transition: 0.25s ease-in-out;">
            Ver Tareas Ordenadas
        </a>
    </div>

    <!-- Mensajes flash -->
    <div style="max-width:1000px;margin:18px auto;">
        <div th:if="${mensajeConfirmacion != null}" class="flash flash-success" th:text="${mensajeConfirmacion}"></div>
        <div th:if="${error != null}" class="flash flash-error" th:text="${error}"></div>
    </div>

    <main class="grid">

        <!-- SecciÃ³n: AÃ±adir Tarea -->
        <section class="card">
            <h2>AÃ±adir tarea</h2>
            <form th:action="@{/agregar}" th:object="${tareaNueva}" method="post" class="form" id="formTask">

                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <div class="field">
                    <label for="titulo">TÃ­tulo</label>
                    <input id="titulo" th:field="*{titulo}" name="titulo" type="text" placeholder="Ej. Terminar informe" required />
                </div>

                <div class="field">
                    <label for="descripcion">DescripciÃ³n</label>
                    <textarea id="descripcion" th:field="*{descripcion}" name="descripcion" placeholder="Detalles opcionales"></textarea>
                </div>

                <div class="field">
                    <label for="prioridad">Prioridad</label>
                    <select id="prioridad" th:field="*{prioridad}" name="prioridad">
                        <option th:each="p : ${prioridades}" th:value="${p}" th:text="${p}">ALTA</option>
                    </select>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" type="submit">Agregar Tarea</button>
                    <button class="btn btn-ghost" type="reset">Limpiar</button>
                </div>
            </form>
        </section>

        <!-- SecciÃ³n: Lista de Tareas por Prioridad -->

        <section class="card full-width">
            <h2>Lista de Tareas por Prioridad</h2>

            <!-- ALTA -->
            <h3>Prioridad ALTA</h3>
            <div class="tasks" th:if="${tareasAlta != null and !#lists.isEmpty(tareasAlta)}">
                <div class="task-row"
                     th:each="tarea : ${tareasAlta}"
                     th:classappend="${tarea != null and tarea.estado != null and tarea.estado.name() == 'COMPLETADA'} ? 'completada' : ''">
                    <div class="task-info">
                        <div class="task-title" th:text="${tarea.titulo ?: 'TÃ­tulo de tarea'}">TÃ­tulo</div>
                        <div class="task-desc" th:text="${tarea.descripcion ?: 'Sin descripciÃ³n'}">DescripciÃ³n</div>
                        <div class="task-meta">
                            <span class="task-priority priority-ALTA" th:text="${tarea.prioridad ?: 'ALTA'}">ALTA</span>
                            <span th:text="${tarea.estado ?: 'PENDIENTE'}"></span>
                        </div>
                    </div>
                    <div class="task-actions">
                        <form th:action="@{/completar/{id}(id=${tarea.id})}" method="post">
                            <button class="btn btn-success btn-small" th:if="${tarea.estado.name() != 'COMPLETADA'}">âœ“</button>
                        </form>

                        <form th:action="@{/encolar/{id}(id=${tarea.id})}" method="post">
                            <button class="btn btn-primary btn-small" th:if="${tarea.estado.name() != 'COMPLETADA'}">Encolar</button>
                        </form>

                        <form th:action="@{/eliminar/{id}(id=${tarea.id})}" method="post">
                            <button class="btn btn-danger btn-small">âœ•</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="empty-state" th:if="${tareasAlta == null or #lists.isEmpty(tareasAlta)}">
                No hay tareas en esta prioridad.
            </div>

            <!-- MEDIA -->
            <h3>Prioridad MEDIA</h3>
            <div class="tasks" th:if="${tareasMedia != null and !#lists.isEmpty(tareasMedia)}">
                <div class="task-row" th:each="tarea : ${tareasMedia}">
                    <div class="task-info">
                        <div class="task-title" th:text="${tarea.titulo ?: 'TÃ­tulo'}"></div>
                        <div class="task-desc" th:text="${tarea.descripcion ?: 'Sin descripciÃ³n'}"></div>
                        <div class="task-meta">
                            <span class="task-priority priority-MEDIA" th:text="${tarea.prioridad}">MEDIA</span>
                            <span th:text="${tarea.estado}"></span>
                        </div>
                    </div>

                    <div class="task-actions">
                        <form th:action="@{/completar/{id}(id=${tarea.id})}" method="post">
                            <button class="btn btn-success btn-small" th:if="${tarea.estado.name() != 'COMPLETADA'}">âœ“</button>
                        </form>

                        <form th:action="@{/encolar/{id}(id=${tarea.id})}" method="post">
                            <button class="btn btn-primary btn-small" th:if="${tarea.estado.name() != 'COMPLETADA'}">Encolar</button>
                        </form>

                        <form th:action="@{/eliminar/{id}(id=${tarea.id})}" method="post">
                            <button class="btn btn-danger btn-small">âœ•</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="empty-state" th:if="${tareasMedia == null or #lists.isEmpty(tareasMedia)}">
                No hay tareas en esta prioridad.
            </div>

            <!-- BAJA -->
            <h3>Prioridad BAJA</h3>
            <div class="tasks" th:if="${tareasBaja != null and !#lists.isEmpty(tareasBaja)}">
                <div class="task-row" th:each="tarea : ${tareasBaja}">
                    <div class="task-info">
                        <div class="task-title" th:text="${tarea.titulo ?: 'TÃ­tulo'}"></div>
                        <div class="task-desc" th:text="${tarea.descripcion ?: 'Sin descripciÃ³n'}"></div>
                        <div class="task-meta">
                            <span class="task-priority priority-BAJA" th:text="${tarea.prioridad}">BAJA</span>
                            <span th:text="${tarea.estado}"></span>
                        </div>
                    </div>

                    <div class="task-actions">
                        <form th:action="@{/completar/{id}(id=${tarea.id})}" method="post">
                            <button class="btn btn-success btn-small" th:if="${tarea.estado.name() != 'COMPLETADA'}">âœ“</button>
                        </form>

                        <form th:action="@{/encolar/{id}(id=${tarea.id})}" method="post">
                            <button class="btn btn-primary btn-small" th:if="${tarea.estado.name() != 'COMPLETADA'}">Encolar</button>
                        </form>

                        <form th:action="@{/eliminar/{id}(id=${tarea.id})}" method="post">
                            <button class="btn btn-danger btn-small">âœ•</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="empty-state" th:if="${tareasBaja == null or #lists.isEmpty(tareasBaja)}">
                No hay tareas en esta prioridad.
            </div>
        </section>

        <!-- Cola -->
        <section class="card full-width cola-section">
            <h2>Cola de Procesamiento</h2>
            <div class="muted">Tareas listas para ser procesadas (FIFO)</div>

            <div class="tasks" th:if="${colaTareas != null and !#lists.isEmpty(colaTareas)}">
                <div class="task-row" th:each="tarea, iter : ${colaTareas}">
                    <div class="task-info">
                        <div class="task-title" th:text="${tarea.titulo}"></div>
                        <div class="task-desc" th:text="${tarea.descripcion}"></div>
                        <div class="task-meta">
                            <span class="task-priority"
                                  th:classappend="' priority-' + tarea.prioridad"
                                  th:text="${tarea.prioridad}"></span>
                            <span>PosiciÃ³n: <strong th:text="${iter.index + 1}"></strong></span>
                        </div>
                    </div>

                    <div class="task-actions">
                        <form th:action="@{/procesar}" method="post">
                            <button class="btn btn-success btn-small">Procesar</button>
                        </form>

                        <form th:action="@{/desencolar}" method="post">
                            <button class="btn btn-warning btn-small">Quitar</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="empty-state" th:if="${colaTareas == null or #lists.isEmpty(colaTareas)}">
                La cola estÃ¡ vacÃ­a.
            </div>
        </section>

        <!-- Historial -->
        <section class="card full-width historial-section">
            <h2>Historial Reciente</h2>

            <!-- âœ” BOTÃ“N NUEVO PARA LIMPIAR HISTORIAL -->
            <div style="text-align: right; margin-bottom: 15px;">
                <form th:action="@{/limpiarHistorial}" method="post" style="display:inline;">
                    <button class="btn btn-danger"
                            style="
                            border-radius: 12px;
                            padding: 8px 16px;
                            font-weight: 600;
                            box-shadow: 0 4px 12px rgba(255,0,0,0.25);">
                        Limpiar Historial
                    </button>
                </form>
            </div>

            <div class="muted">Ãšltimas acciones (LIFO)</div>

            <div class="tasks" th:if="${pilaHistorial != null and !#lists.isEmpty(pilaHistorial)}">
                <div class="task-row" th:each="accion : ${pilaHistorial}">
                    <div class="task-info">
                        <div class="task-title" th:text="${accion.titulo}"></div>
                        <div class="task-desc" th:text="${accion.descripcion}"></div>
                        <div class="task-meta">
                            <span th:text="${#temporals.format(accion.fechaCreacion, 'dd/MM/yyyy HH:mm:ss')}"></span>
                            <span th:text="${accion.accion}"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="empty-state" th:if="${pilaHistorial == null or #lists.isEmpty(pilaHistorial)}">
                No hay acciones recientes.
            </div>
        </section>
    </main>

    <footer style="margin-top:60px;text-align:center;color:#9fb4d4;font-size:13px;padding:20px 0;border-top:1px solid rgba(255,255,255,0.05);">
        <p>Sistema de GestiÃ³n de Tareas &copy; 2024 - Implementando Estructuras de Datos</p>
    </footer>
</div>
</body>
</html>
