<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Inicio — Sistema de Tareas</title>
    <link rel="stylesheet" th:href="@{/css/estilos.css}" href="/css/estilos.css" />
</head>
<body>
<div class="wrap">
    <header>
        <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div>
                <h1>Sistema de Gestión de Tareas</h1>
                <p class="lead">Bienvenido, <span th:text="${usuario != null ? usuario.nombre : 'Usuario'}">Usuario</span></p>
            </div>
        </div>

        <div class="center">
            <div style="text-align:right; margin-right: 20px;">
                <div class="muted">Usuario</div>
                <div style="font-weight: 600; color: #e6eef8;" th:text="${usuario != null ? usuario.nombre : 'Usuario'}">Usuario</div>
                <div style="margin-top: 5px;">
                    <span style="font-size: 12px; color: #9fb4d4; margin-right: 10px;">|</span>
                    <form th:action="@{/logout}" method="post" style="display:inline;">
                        <button type="submit" style="background: none; border: none; color: #9fb4d4; font-size: 12px; cursor: pointer;">
                            Cerrar Sesión
                        </button>
                    </form>
                </div>
            </div>

            <div style="text-align:right">
                <div class="muted">Siguiente en cola</div>
                <div id="colaFrontSmall" class="muted" th:text="${siguienteEnCola != null ? siguienteEnCola : '—'}">—</div>
            </div>
            <div class="queue-indicator" id="queueCount" th:text="${totalEnCola != null ? totalEnCola : 0}">0</div>
        </div>
    </header>

    <div th:if="${estadisticas != null}" style="max-width:1000px; margin: 20px auto; display: flex; gap: 10px; flex-wrap: wrap;">
        <div style="background: rgba(34, 197, 94, 0.1); color: #22c55e; padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: 600;">
            Total: <span th:text="${estadisticas.total}">0</span>
        </div>
        <div style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: 600;">
            Completadas: <span th:text="${estadisticas.completadas}">0</span>
        </div>
        <div style="background: rgba(245, 158, 11, 0.1); color: #f59e0b; padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: 600;">
            Pendientes: <span th:text="${estadisticas.pendientes}">0</span>
        </div>
        <div style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: 600;">
            Alta: <span th:text="${estadisticas.alta}">0</span>
        </div>
    </div>

    <div style="display:flex; gap:15px; margin:30px 0; max-width:1000px; margin-left:auto; margin-right:auto;">
        <form method="get" action="/" class="search-form">
            <input type="text" name="busqueda" placeholder="Buscar tareas..." th:value="${busqueda ?: ''}" autocomplete="off" />
            <button type="submit">Buscar</button>
        </form>

        <a href="/ordenadas" class="btn btn-secondary" style="padding: 12px 20px; display:flex; align-items:center; gap:8px;">
            Ordenar por prioridad
        </a>
    </div>

    <div class="flash-messages">
        <div th:if="${mensajeConfirmacion}" class="alert alert-success" role="alert">
            <span th:text="${mensajeConfirmacion}">Mensaje de confirmación</span>
        </div>
        <div th:if="${error}" class="alert alert-error" role="alert">
            <span th:text="${error}">Mensaje de error</span>
        </div>
    </div>

    <div class="main-content">
        <div th:if="${busqueda != null and !#strings.isEmpty(busqueda)}">
            <h2>Resultados de búsqueda: "<span th:text="${busqueda}"></span>"</h2>
            <div th:if="${resultadosBusqueda != null and !resultadosBusqueda.isEmpty()}">
                <div class="task-list">
                    <div th:each="tarea : ${resultadosBusqueda}" class="task-item">
                        <div class="task-priority" th:classappend="'priority-' + ${tarea.prioridad.toString().toLowerCase()}"></div>
                        <div class="task-content">
                            <div class="task-header">
                                <strong th:text="${tarea.titulo}">Título</strong>
                                <span class="task-status" th:text="${tarea.estado}">Estado</span>
                            </div>
                            <div class="task-desc" th:text="${tarea.descripcion} ?: 'Sin descripción'">Descripción</div>
                            <div class="task-actions">
                                <a th:href="@{/editar/{id}(id=${tarea.id})}" class="btn btn-small">Editar</a>
                                <form th:action="@{/encolar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small">Encolar</button>
                                </form>
                                <form th:action="@{/eliminar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('¿Eliminar esta tarea?')">Eliminar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div th:if="${resultadosBusqueda == null or resultadosBusqueda.isEmpty()}">
                <p class="muted">No se encontraron tareas para "<span th:text="${busqueda}"></span>"</p>
            </div>
        </div>

        <div th:unless="${busqueda != null and !#strings.isEmpty(busqueda)}">
            <section th:if="${tareasAlta != null and !tareasAlta.isEmpty()}">
                <h2>Tareas de <span class="priority-high">ALTA</span> prioridad</h2>
                <div class="task-list">
                    <div th:each="tarea : ${tareasAlta}" class="task-item">
                        <div class="task-priority priority-alta"></div>
                        <div class="task-content">
                            <div class="task-header">
                                <strong th:text="${tarea.titulo}">Título</strong>
                                <span class="task-status" th:text="${tarea.estado}">Estado</span>
                            </div>
                            <div class="task-desc" th:text="${tarea.descripcion} ?: 'Sin descripción'">Descripción</div>
                            <div class="task-actions">
                                <a th:href="@{/editar/{id}(id=${tarea.id})}" class="btn btn-small">Editar</a>
                                <form th:action="@{/encolar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small">Encolar</button>
                                </form>
                                <form th:action="@{/completar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small" th:if="${tarea.estado.toString() == 'PENDIENTE'}">Completar</button>
                                </form>
                                <form th:action="@{/eliminar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('¿Eliminar esta tarea?')">Eliminar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section th:if="${tareasMedia != null and !tareasMedia.isEmpty()}">
                <h2>Tareas de <span class="priority-medium">MEDIA</span> prioridad</h2>
                <div class="task-list">
                    <div th:each="tarea : ${tareasMedia}" class="task-item">
                        <div class="task-priority priority-media"></div>
                        <div class="task-content">
                            <div class="task-header">
                                <strong th:text="${tarea.titulo}">Título</strong>
                                <span class="task-status" th:text="${tarea.estado}">Estado</span>
                            </div>
                            <div class="task-desc" th:text="${tarea.descripcion} ?: 'Sin descripción'">Descripción</div>
                            <div class="task-actions">
                                <a th:href="@{/editar/{id}(id=${tarea.id})}" class="btn btn-small">Editar</a>
                                <form th:action="@{/encolar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small">Encolar</button>
                                </form>
                                <form th:action="@{/completar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small" th:if="${tarea.estado.toString() == 'PENDIENTE'}">Completar</button>
                                </form>
                                <form th:action="@{/eliminar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('¿Eliminar esta tarea?')">Eliminar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section th:if="${tareasBaja != null and !tareasBaja.isEmpty()}">
                <h2>Tareas de <span class="priority-low">BAJA</span> prioridad</h2>
                <div class="task-list">
                    <div th:each="tarea : ${tareasBaja}" class="task-item">
                        <div class="task-priority priority-baja"></div>
                        <div class="task-content">
                            <div class="task-header">
                                <strong th:text="${tarea.titulo}">Título</strong>
                                <span class="task-status" th:text="${tarea.estado}">Estado</span>
                            </div>
                            <div class="task-desc" th:text="${tarea.descripcion} ?: 'Sin descripción'">Descripción</div>
                            <div class="task-actions">
                                <a th:href="@{/editar/{id}(id=${tarea.id})}" class="btn btn-small">Editar</a>
                                <form th:action="@{/encolar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small">Encolar</button>
                                </form>
                                <form th:action="@{/completar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small" th:if="${tarea.estado.toString() == 'PENDIENTE'}">Completar</button>
                                </form>
                                <form th:action="@{/eliminar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('¿Eliminar esta tarea?')">Eliminar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <section>
            <h2>Crear nueva tarea</h2>
            <form th:action="@{/agregar}" method="post" th:object="${tareaNueva}" class="task-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="titulo">Título</label>
                        <input type="text" id="titulo" th:field="*{titulo}" placeholder="Ej: Revisar correos" required />
                    </div>
                    <div class="form-group">
                        <label for="prioridad">Prioridad</label>
                        <select id="prioridad" th:field="*{prioridad}">
                            <option th:each="p : ${prioridades}" th:value="${p}" th:text="${p}">MEDIA</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="descripcion">Descripción</label>
                    <textarea id="descripcion" th:field="*{descripcion}" placeholder="Descripción detallada de la tarea..." rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Agregar tarea</button>
            </form>
        </section>

        <section th:if="${not colaTareas.isEmpty()}">
            <h2>Cola de procesamiento (<span th:text="${totalEnCola}">0</span> tareas)</h2>
            <div class="queue-panel">
                <div class="queue-header">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <span>Siguiente: <strong th:text="${siguienteEnCola != null ? siguienteEnCola : '—'}">—</strong></span>
                        <form th:action="@{/procesar}" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-success btn-small">Procesar siguiente</button>
                        </form>
                        <form th:action="@{/desencolar}" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-warning btn-small">Desencolar</button>
                        </form>
                    </div>
                </div>
                <div class="queue-list" id="colaLista">
                    <div th:each="tarea : ${colaTareas}" class="queue-item">
                        <div class="queue-item-priority" th:classappend="'priority-' + ${tarea.prioridad.toString().toLowerCase()}"></div>
                        <div class="queue-item-content">
                            <strong th:text="${tarea.titulo}">Título</strong>
                            <div class="muted" style="font-size:13px;" th:text="${tarea.descripcion ?: 'Sin descripción'}">Descripción</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section th:if="${pilaHistorial != null and !pilaHistorial.isEmpty()}">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2>Historial de acciones (<span th:text="${pilaHistorial.size()}">0</span>)</h2>
                <form th:action="@{/limpiarHistorial}" method="post">
                    <button type="submit" class="btn btn-small btn-warning" onclick="return confirm('¿Limpiar todo el historial?')">Limpiar historial</button>
                </form>
            </div>
            <div class="history-panel" id="historialLista">
                <div th:each="historial : ${pilaHistorial}" class="history-item">
                    <div class="history-time">
                        <span th:text="${historial.fecha != null ? #temporals.format(historial.fecha, 'HH:mm') : '--:--'}">10:00</span>
                    </div>
                    <div class="history-content">
                        <div class="history-title">
                            <strong th:text="${historial.titulo}">Título</strong>
                            <span class="history-action" th:text="${historial.accion}">Acción</span>
                        </div>
                        <div class="history-desc" th:text="${historial.descripcion}">Descripción</div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <footer>
        <p class="muted">Sistema de Gestión de Tareas &copy; 2025</p>
        <p class="muted" style="margin-top:5px;">
            Usuario: <span th:text="${usuario.email}">usuario@ejemplo.com</span> |
        </p>
    </footer>
</div>


</body>
</html>
