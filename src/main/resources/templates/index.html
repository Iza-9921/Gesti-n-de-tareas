<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Inicio ‚Äî Sistema de Tareas</title>
    <link rel="stylesheet" th:href="@{/css/estilos.css}" href="/css/estilos.css" />
</head>
<body>
<div class="wrap">
    <header>
        <div class="brand">
            <div class="logo" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M4 12c0-4.418 3.582-8 8-8s8 3.582 8 8" stroke="#fff" stroke-opacity="0.95" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div>
                <h1>Sistema de Gesti√≥n de Tareas</h1>
                <p class="lead" th:text="'Bienvenido, ' + ${usuario.nombre}">Bienvenido, Usuario</p>
            </div>
        </div>

        <div class="center">
            <!-- Informaci√≥n del usuario -->
            <div style="text-align:right; margin-right: 20px;">
                <div class="muted">Usuario</div>
                <div style="font-weight: 600; color: #e6eef8;" th:text="${usuario.nombre}">Usuario</div>
                <div style="margin-top: 5px;">
                    <span style="font-size: 12px; color: #9fb4d4; margin-right: 10px;">|</span>
                    <form th:action="@{/logout}" method="post" style="display:inline;">
                        <button type="submit" style="background: none; border: none; color: #9fb4d4; font-size: 12px; cursor: pointer;">
                            Cerrar Sesi√≥n
                        </button>
                    </form>
                </div>
            </div>

            <div style="text-align:right">
                <div class="muted">Siguiente en cola</div>
                <div id="colaFrontSmall" class="muted" th:text="${siguienteEnCola != null ? siguienteEnCola : '‚Äî'}">‚Äî</div>
            </div>
            <div class="queue-indicator" id="queueCount" th:text="${totalEnCola != null ? totalEnCola : 0}">0</div>
        </div>
    </header>

    <!-- Estad√≠sticas del usuario -->
    <div th:if="${estadisticas != null}" style="max-width:1000px; margin: 20px auto; display: flex; gap: 10px; flex-wrap: wrap;">
        <div style="background: rgba(34, 197, 94, 0.1); color: #22c55e; padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: 600;">
            üìä Total: <span th:text="${estadisticas.total}">0</span>
        </div>
        <div style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: 600;">
            ‚úÖ Completadas: <span th:text="${estadisticas.completadas}">0</span>
        </div>
        <div style="background: rgba(245, 158, 11, 0.1); color: #f59e0b; padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: 600;">
            ‚è≥ Pendientes: <span th:text="${estadisticas.pendientes}">0</span>
        </div>
        <div style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: 600;">
            üî¥ Alta: <span th:text="${estadisticas.alta}">0</span>
        </div>
    </div>

    <!-- Bot√≥n de b√∫squeda y ordenar -->
    <div style="display:flex; gap:15px; margin:30px 0; max-width:1000px; margin-left:auto; margin-right:auto;">
        <form method="get" action="/" class="search-form">
            <input type="text" name="busqueda" placeholder="Buscar tareas..." th:value="${busqueda ?: ''}" autocomplete="off" />
            <button type="submit">üîç</button>
        </form>

        <a href="/ordenadas" class="btn btn-secondary" style="padding: 12px 20px; display:flex; align-items:center; gap:8px;">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h9m5-4v12m0 0l-4-4m4 4l4-4" />
            </svg>
            Ordenar por prioridad
        </a>
    </div>

    <!-- Mensajes de confirmaci√≥n/error -->
    <div class="flash-messages">
        <div th:if="${mensajeConfirmacion}" class="alert alert-success" role="alert">
            <span th:text="${mensajeConfirmacion}">Mensaje de confirmaci√≥n</span>
        </div>
        <div th:if="${error}" class="alert alert-error" role="alert">
            <span th:text="${error}">Mensaje de error</span>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="main-content">

        <!-- Si hay b√∫squeda, mostrar resultados -->
        <div th:if="${busqueda != null and not busqueda.isEmpty()}">
            <h2>Resultados de b√∫squeda: "<span th:text="${busqueda}"></span>"</h2>
            <div th:if="${resultadosBusqueda != null and not resultadosBusqueda.isEmpty()}">
                <div class="task-list">
                    <div th:each="tarea : ${resultadosBusqueda}" class="task-item">
                        <div class="task-priority" th:classappend="'priority-' + ${tarea.prioridad.toString().toLowerCase()}"></div>
                        <div class="task-content">
                            <div class="task-header">
                                <strong th:text="${tarea.titulo}">T√≠tulo</strong>
                                <span class="task-status" th:text="${tarea.estado}">Estado</span>
                            </div>
                            <div class="task-desc" th:text="${tarea.descripcion} ?: 'Sin descripci√≥n'">Descripci√≥n</div>
                            <div class="task-actions">
                                <a th:href="@{/editar/{id}(id=${tarea.id})}" class="btn btn-small">‚úèÔ∏è Editar</a>
                                <form th:action="@{/encolar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small">üì• Encolar</button>
                                </form>
                                <form th:action="@{/eliminar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('¬øEliminar esta tarea?')">üóëÔ∏è Eliminar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div th:if="${resultadosBusqueda == null or resultadosBusqueda.isEmpty()}">
                <p class="muted">No se encontraron tareas para "<span th:text="${busqueda}"></span>"</p>
            </div>
        </div>

        <!-- Si no hay b√∫squeda, mostrar tareas por prioridad -->
        <div th:unless="${busqueda != null and not busqueda.isEmpty()}">
            <!-- Tareas ALTA -->
            <section th:if="${not tareasAlta.isEmpty()}">
                <h2>Tareas de <span class="priority-high">ALTA</span> prioridad</h2>
                <div class="task-list">
                    <div th:each="tarea : ${tareasAlta}" class="task-item">
                        <div class="task-priority priority-alta"></div>
                        <div class="task-content">
                            <div class="task-header">
                                <strong th:text="${tarea.titulo}">T√≠tulo</strong>
                                <span class="task-status" th:text="${tarea.estado}">Estado</span>
                            </div>
                            <div class="task-desc" th:text="${tarea.descripcion} ?: 'Sin descripci√≥n'">Descripci√≥n</div>
                            <div class="task-actions">
                                <a th:href="@{/editar/{id}(id=${tarea.id})}" class="btn btn-small">‚úèÔ∏è Editar</a>
                                <form th:action="@{/encolar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small">üì• Encolar</button>
                                </form>
                                <form th:action="@{/completar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small" th:if="${tarea.estado.toString() == 'PENDIENTE'}">‚úÖ Completar</button>
                                </form>
                                <form th:action="@{/eliminar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('¬øEliminar esta tarea?')">üóëÔ∏è Eliminar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tareas MEDIA -->
            <section th:if="${not tareasMedia.isEmpty()}">
                <h2>Tareas de <span class="priority-medium">MEDIA</span> prioridad</h2>
                <div class="task-list">
                    <div th:each="tarea : ${tareasMedia}" class="task-item">
                        <div class="task-priority priority-media"></div>
                        <div class="task-content">
                            <div class="task-header">
                                <strong th:text="${tarea.titulo}">T√≠tulo</strong>
                                <span class="task-status" th:text="${tarea.estado}">Estado</span>
                            </div>
                            <div class="task-desc" th:text="${tarea.descripcion} ?: 'Sin descripci√≥n'">Descripci√≥n</div>
                            <div class="task-actions">
                                <a th:href="@{/editar/{id}(id=${tarea.id})}" class="btn btn-small">‚úèÔ∏è Editar</a>
                                <form th:action="@{/encolar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small">üì• Encolar</button>
                                </form>
                                <form th:action="@{/completar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small" th:if="${tarea.estado.toString() == 'PENDIENTE'}">‚úÖ Completar</button>
                                </form>
                                <form th:action="@{/eliminar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('¬øEliminar esta tarea?')">üóëÔ∏è Eliminar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tareas BAJA -->
            <section th:if="${not tareasBaja.isEmpty()}">
                <h2>Tareas de <span class="priority-low">BAJA</span> prioridad</h2>
                <div class="task-list">
                    <div th:each="tarea : ${tareasBaja}" class="task-item">
                        <div class="task-priority priority-baja"></div>
                        <div class="task-content">
                            <div class="task-header">
                                <strong th:text="${tarea.titulo}">T√≠tulo</strong>
                                <span class="task-status" th:text="${tarea.estado}">Estado</span>
                            </div>
                            <div class="task-desc" th:text="${tarea.descripcion} ?: 'Sin descripci√≥n'">Descripci√≥n</div>
                            <div class="task-actions">
                                <a th:href="@{/editar/{id}(id=${tarea.id})}" class="btn btn-small">‚úèÔ∏è Editar</a>
                                <form th:action="@{/encolar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small">üì• Encolar</button>
                                </form>
                                <form th:action="@{/completar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small" th:if="${tarea.estado.toString() == 'PENDIENTE'}">‚úÖ Completar</button>
                                </form>
                                <form th:action="@{/eliminar/{id}(id=${tarea.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('¬øEliminar esta tarea?')">üóëÔ∏è Eliminar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Formulario para nueva tarea -->
        <section>
            <h2>Crear nueva tarea</h2>
            <form th:action="@{/agregar}" method="post" th:object="${tareaNueva}" class="task-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="titulo">T√≠tulo</label>
                        <input type="text" id="titulo" th:field="*{titulo}" placeholder="Ej: Revisar correos" required />
                    </div>
                    <div class="form-group">
                        <label for="prioridad">Prioridad</label>
                        <select id="prioridad" th:field="*{prioridad}">
                            <option th:each="p : ${prioridades}" th:value="${p}" th:text="${p}">MEDIA</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="descripcion">Descripci√≥n</label>
                    <textarea id="descripcion" th:field="*{descripcion}" placeholder="Descripci√≥n detallada de la tarea..." rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">‚ûï Agregar tarea</button>
            </form>
        </section>

        <!-- Panel de cola de procesamiento -->
        <section th:if="${not colaTareas.isEmpty()}">
            <h2>Cola de procesamiento (<span th:text="${totalEnCola}">0</span> tareas)</h2>
            <div class="queue-panel">
                <div class="queue-header">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <span>Siguiente: <strong th:text="${siguienteEnCola}">‚Äî</strong></span>
                        <form th:action="@{/procesar}" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-success btn-small">Procesar siguiente</button>
                        </form>
                        <form th:action="@{/desencolar}" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-warning btn-small">Desencolar</button>
                        </form>
                    </div>
                </div>
                <div class="queue-list">
                    <div th:each="tarea : ${colaTareas}" class="queue-item">
                        <div class="queue-item-priority" th:classappend="'priority-' + ${tarea.prioridad.toString().toLowerCase()}"></div>
                        <div class="queue-item-content">
                            <strong th:text="${tarea.titulo}">T√≠tulo</strong>
                            <div class="muted" style="font-size:13px;" th:text="${tarea.descripcion ?: 'Sin descripci√≥n'}">Descripci√≥n</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Panel de historial -->
        <section th:if="${not pilaHistorial.isEmpty()}">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2>Historial de acciones (<span th:text="${pilaHistorial.size()}">0</span>)</h2>
                <form th:action="@{/limpiarHistorial}" method="post">
                    <button type="submit" class="btn btn-small btn-warning" onclick="return confirm('¬øLimpiar todo el historial?')">Limpiar historial</button>
                </form>
            </div>
            <div class="history-panel">
                <div th:each="historial : ${pilaHistorial}" class="history-item">
                    <div class="history-time">
                        <span th:text="${historial.fecha != null ? #temporals.format(historial.fecha, 'HH:mm') : '--:--'}">10:00</span>                    </div>
                    <div class="history-content">
                        <div class="history-title">
                            <strong th:text="${historial.titulo}">T√≠tulo</strong>
                            <span class="history-action" th:text="${historial.accion}">Acci√≥n</span>
                        </div>
                        <div class="history-desc" th:text="${historial.descripcion}">Descripci√≥n</div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <footer>
        <p class="muted">Sistema de Gesti√≥n de Tareas &copy; 2025</p>
        <p class="muted" style="margin-top:5px;">
            Usuario: <span th:text="${usuario.email}">usuario@ejemplo.com</span> |
        </p>
    </footer>
</div>
</body>
</html>